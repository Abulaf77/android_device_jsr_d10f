From 1eb14ecf513dce0ab7fefd3c402a80f5eec01349 Mon Sep 17 00:00:00 2001
From: Gabriele M <moto.falcon.git@gmail.com>
Date: Wed, 24 Feb 2016 17:46:49 +0100
Subject: [PATCH] Allow to ignore presentation indicator of outgoing calls
 [2/3]

With some mobile network operators, the presentation indicator of
outgoing calls is always set to either "unknown" or "restricted".
As consequence, the dialed number doesn't show up in clear in the
call history. Allow to ignore the presentation indicator of outgoing
calls to never hide the dialed numbers.

Change-Id: Ifb5a11d3b46e22d7cdc502d447a55b307226ff71
---
 Android.mk                                                     | 1 +
 src/java/com/android/internal/telephony/GsmCdmaConnection.java | 9 ++++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/Android.mk b/Android.mk
index 53b1ee6..28bf417 100644
--- a/Android.mk
+++ b/Android.mk
@@ -27,6 +27,7 @@ LOCAL_SRC_FILES := $(call all-java-files-under, src/java) \
 
 LOCAL_JAVA_LIBRARIES := voip-common ims-common
 LOCAL_STATIC_JAVA_LIBRARIES := ims-ext-common
+LOCAL_STATIC_JAVA_LIBRARIES += org.cyanogenmod.platform.internal
 
 ifneq ($(BOARD_RIL_CLASS),)
 LOCAL_SRC_FILES += $(call find-other-java-files,$(BOARD_RIL_CLASS))
diff --git a/src/java/com/android/internal/telephony/GsmCdmaConnection.java b/src/java/com/android/internal/telephony/GsmCdmaConnection.java
index 16eef59..b2009e7 100644
--- a/src/java/com/android/internal/telephony/GsmCdmaConnection.java
+++ b/src/java/com/android/internal/telephony/GsmCdmaConnection.java
@@ -37,6 +37,8 @@ import com.android.internal.telephony.uicc.UiccCardApplication;
 import com.android.internal.telephony.uicc.UiccController;
 import com.android.internal.telephony.uicc.IccCardApplicationStatus.AppState;
 
+import cyanogenmod.providers.CMSettings;
+
 /**
  * {@hide}
  */
@@ -640,7 +642,12 @@ public class GsmCdmaConnection extends Connection {
 
         if (Phone.DEBUG_PHONE) log("--dssds----"+mCnapName);
         mCnapNamePresentation = dc.namePresentation;
-        mNumberPresentation = dc.numberPresentation;
+
+        boolean connectedLineIdentification =
+                CMSettings.System.getInt(mOwner.mPhone.getContext().getContentResolver(),
+                        CMSettings.System.CONNECTED_LINE_IDENTIFICATION, 1) != 0;
+        if (mIsIncoming || connectedLineIdentification)
+            mNumberPresentation = dc.numberPresentation;
 
         if (newParent != mParent) {
             if (mParent != null) {
-- 
2.9.3

