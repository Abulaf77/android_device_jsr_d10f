From 2cb9785dd729c9758bf2e510b439a0401a87eac9 Mon Sep 17 00:00:00 2001
From: S-trace <S-trace@list.ru>
Date: Mon, 13 Mar 2017 21:26:55 +0300
Subject: [PATCH 17/20] [COMPRESSORS] Add lrzip compressor support

---
 Android.mk                     |  3 +-
 gui/theme/common/landscape.xml |  6 +++
 gui/theme/common/portrait.xml  |  1 +
 gui/theme/common/watch.xml     |  1 +
 lrzip/Android.mk               | 94 ++++++++++++++++++++++++++++++++++++++++++
 prebuilt/Android.mk            |  1 +
 twrp-functions.cpp             |  9 ++++
 twrpTar.cpp                    |  3 ++
 8 files changed, 117 insertions(+), 1 deletion(-)
 create mode 100644 lrzip/Android.mk

diff --git a/Android.mk b/Android.mk
index fe740f8..7b97ade 100644
--- a/Android.mk
+++ b/Android.mk
@@ -464,7 +464,7 @@ ifeq ($(TWRP_INCLUDE_LOGCAT), true)
     endif
 endif
 ifneq ($(TW_NO_ADVANCED_COMPRESSION), true)
-    LOCAL_ADDITIONAL_DEPENDENCIES += uunpack zstd pbzip2 lzop
+    LOCAL_ADDITIONAL_DEPENDENCIES += uunpack zstd pbzip2 lzop lrzip
 endif
 # Allow devices to specify device-specific recovery dependencies
 ifneq ($(TARGET_RECOVERY_DEVICE_MODULES),)
@@ -738,6 +738,7 @@ ifneq ($(TW_NO_ADVANCED_COMPRESSION), true)
     include $(commands_recovery_local_path)/zstd/Android.mk
     include $(commands_recovery_local_path)/pbzip2/Android.mk
     include $(commands_recovery_local_path)/lzop/Android.mk
+    include $(commands_recovery_local_path)/lrzip/Android.mk
 endif
 
 # FB2PNG
diff --git a/gui/theme/common/landscape.xml b/gui/theme/common/landscape.xml
index 4e5cd5a..c8433f9 100644
--- a/gui/theme/common/landscape.xml
+++ b/gui/theme/common/landscape.xml
@@ -1772,6 +1772,11 @@
 				<listitem name="pbzip2 -7">pbzip2 -7</listitem>
 				<listitem name="pbzip2 -8">pbzip2 -8</listitem>
 				<listitem name="pbzip2 -9">pbzip2 -9</listitem>
+				<listitem name="lzop -1">lzop -1</listitem>
+				<listitem name="lzop -3">lzop -3</listitem>
+				<listitem name="lzop -7">lzop -7</listitem>
+				<listitem name="lzop -8">lzop -8</listitem>
+				<listitem name="lzop -9">lzop -9</listitem>
 				<listitem name="zstd -1">zstd -1</listitem>
 				<listitem name="zstd -2">zstd -2</listitem>
 				<listitem name="zstd -3">zstd -3</listitem>
@@ -1791,6 +1796,7 @@
 				<listitem name="zstd -17">zstd -17</listitem>
 				<listitem name="zstd -18">zstd -18</listitem>
 				<listitem name="zstd -19">zstd -19</listitem>
+				<listitem name="lrzip">lrzip</listitem>
 			</listbox>
 
 			<button style="main_button">
diff --git a/gui/theme/common/portrait.xml b/gui/theme/common/portrait.xml
index d4cbc28..ea19f28 100644
--- a/gui/theme/common/portrait.xml
+++ b/gui/theme/common/portrait.xml
@@ -1841,6 +1841,7 @@
 				<listitem name="zstd -17">zstd -17</listitem>
 				<listitem name="zstd -18">zstd -18</listitem>
 				<listitem name="zstd -19">zstd -19</listitem>
+				<listitem name="lrzip">lrzip</listitem>
 				<data name="tw_compressor_guisel" />
 			</listbox>
 
diff --git a/gui/theme/common/watch.xml b/gui/theme/common/watch.xml
index e52c160..6f2f449 100644
--- a/gui/theme/common/watch.xml
+++ b/gui/theme/common/watch.xml
@@ -2173,6 +2173,7 @@
 				<listitem name="zstd -17">zstd -17</listitem>
 				<listitem name="zstd -18">zstd -18</listitem>
 				<listitem name="zstd -19">zstd -19</listitem>
+				<listitem name="lrzip">lrzip</listitem>
 			</listbox>
 
 			<button>
diff --git a/lrzip/Android.mk b/lrzip/Android.mk
new file mode 100644
index 0000000..4ce958c
--- /dev/null
+++ b/lrzip/Android.mk
@@ -0,0 +1,94 @@
+LOCAL_PATH := $(call my-dir)
+
+include $(CLEAR_VARS)
+
+LOCAL_MODULE := lrzip
+LOCAL_MODULE_TAGS := eng optional
+LOCAL_MODULE_CLASS := RECOVERY_EXECUTABLES
+LOCAL_MODULE_PATH := $(TARGET_RECOVERY_ROOT_OUT)/sbin
+
+LOCAL_C_INCLUDES += $(LOCAL_PATH)/lzma/C/ bionic/libc/include/ $(LOCAL_PATH)/ external/zlib/
+LOCAL_C_INCLUDES += external/lzo/include/
+LOCAL_C_INCLUDES += external/bzip2/
+
+LOCAL_CFLAGS += -std=gnu99 -O2 -fomit-frame-pointer \
+	-D_REENTRANT \
+	-DCOMPRESS_MF_MT \
+	-DDISABLE_BZIP2 \
+	-DDISABLE_ZPAQ
+# 	-DDISABLE_LZO
+
+LOCAL_CFLAGS += \
+	-D_GNU_SOURCE \
+	-DHAVE_ERRNO \
+	-DHAVE_ALLOCA_H \
+	-DHAVE_ERRNO_H \
+	-DHAVE_STRERROR \
+	-DHAVE_CTYPE_H \
+	-DHAVE_INTTYPES_H \
+	-DHAVE_PTHREAD_H \
+	-DHAVE_SETENV \
+	-DHAVE_STDINT_H \
+	-DHAVE_STDLIB_H \
+	-DHAVE_STRING_H \
+	-DHAVE_STRINGS_H \
+	-DHAVE_SYS_MMAN_H \
+	-DHAVE_SYS_RESOURCE_H \
+	-DHAVE_SYS_STAT_H \
+	-DHAVE_SYS_TIME_H \
+	-DHAVE_SYS_TYPES_H \
+	-DHAVE_UNISTD_H \
+	-DSIZEOF_SHORT=SIZEOF\(short\) \
+	-DSIZEOF_INT=4 \
+	-DSIZEOF_LONG=8 \
+	-D__UNUSED__=__attribute__\(\(unused\)\)
+
+LOCAL_CFLAGS += \
+	-DLRZIP_MAJOR_VERSION=0 \
+	-DLRZIP_MINOR_SUBVERSION=31 \
+	-DLRZIP_MINOR_VERSION=6 \
+	-DVERSION="0.631"
+
+LOCAL_CFLAGS += \
+	-DPACKAGE="lrzip" \
+	-DPACKAGE_BUGREPORT="kernel@kolivas.org" \
+	-DPACKAGE_NAME="lrzip" \
+	-DPACKAGE_STRING="lrzip 0.631" \
+	-DPACKAGE_TARNAME="lrzip" \
+	-DPACKAGE_URL="" \
+	-DPACKAGE_VERSION="0.631" \
+
+
+LOCAL_SRC_FILES :=  \
+	lzma/C/7zCrc.c \
+	lzma/C/Alloc.c \
+	lzma/C/LzFind.c \
+	lzma/C/LzFindMt.c \
+	lzma/C/LzmaDec.c \
+	lzma/C/LzmaEnc.c \
+	lzma/C/LzmaLib.c \
+	lzma/C/Threads.c \
+	liblrzip.c \
+	lrzip.c \
+	rzip.c \
+	runzip.c \
+	stream.c \
+	util.c \
+	md5.c \
+	aes.c \
+	sha4.c \
+	main.c
+
+LOCAL_SRC_FILES +=  \
+	libzpaq/libzpaq.cpp
+
+LOCAL_STATIC_LIBRARIES += \
+	libbz
+
+LOCAL_STATIC_LIBRARIES += \
+	liblzo-static
+
+LOCAL_SHARED_LIBRARIES := \
+	libz
+
+include $(BUILD_EXECUTABLE)
diff --git a/prebuilt/Android.mk b/prebuilt/Android.mk
index 0f3bbdd..ffba4a9 100644
--- a/prebuilt/Android.mk
+++ b/prebuilt/Android.mk
@@ -31,6 +31,7 @@ else
 	endif
 endif
 ifneq ($(TW_NO_ADVANCED_COMPRESSION), true)
+	RELINK_SOURCE_FILES += $(TARGET_RECOVERY_ROOT_OUT)/sbin/lrzip
 	RELINK_SOURCE_FILES += $(TARGET_RECOVERY_ROOT_OUT)/sbin/pbzip2
 	RELINK_SOURCE_FILES += $(TARGET_RECOVERY_ROOT_OUT)/sbin/zstd
 	RELINK_SOURCE_FILES += $(TARGET_RECOVERY_ROOT_OUT)/sbin/uunpack
diff --git a/twrp-functions.cpp b/twrp-functions.cpp
index 3cbaa08..836cdec 100644
--- a/twrp-functions.cpp
+++ b/twrp-functions.cpp
@@ -207,6 +207,10 @@ Archive_Type TWFunc::Get_File_Type(string fn) {
 		LOGINFO("File '%s' is compressed by bzip2.\n", fn.c_str());
 		return COMPRESSED; // Compressed by bzip2
 	}
+	else if (firstbyte == 0x4c && secondbyte == 0x52 && thirdbyte == 0x5a && fourthbyte == 0x49) {
+		LOGINFO("File '%s' is compressed by lrzip.\n", fn.c_str());
+		return COMPRESSED; // Compressed by lrzip
+	}
 	else if (secondbyte == 0xb5 && thirdbyte == 0x2f && fourthbyte == 0xfd) {
 		LOGINFO("File '%s' is compressed by zstd.\n", fn.c_str());
 		return COMPRESSED; // Compressed by zstd
@@ -314,6 +318,11 @@ int TWFunc::Try_Decrypting_File(string fn, string password) {
 		free(buffer_out);
 		return 3; // Compressed by bzip2+encrypted
 	}
+	else if (firstbyte == 0x4c && secondbyte == 0x52 && thirdbyte == 0x5a && fourthbyte == 0x49) {
+		LOGINFO("Successfully decrypted '%s' and file is compressed by lrzip.\n", fn.c_str());
+		free(buffer_out);
+		return 3; // Compressed by lrzip+encrypted
+	}
 	else if (secondbyte == 0xb5 && thirdbyte == 0x2f && fourthbyte == 0xfd) {
 		LOGINFO("Successfully decrypted '%s' and file is compressed by zstd.\n", fn.c_str());
 		free(buffer_out);
diff --git a/twrpTar.cpp b/twrpTar.cpp
index 48f00a5..8f6c398 100644
--- a/twrpTar.cpp
+++ b/twrpTar.cpp
@@ -1030,6 +1030,9 @@ int twrpTar::execlpCompressor() {
 	if (compression_mode == "zstd -19")
 		ret=execlp("zstd", "zstd", "-19", "-", NULL);
 
+	if (compression_mode == "lrzip")
+		ret=execlp("lrzip", "lrzip", "-", NULL);
+
 	LOGERR("%s: '%s' ERROR (%s)!\n", __func__, compression_mode.c_str(), strerror(errno)); // Should not reach here
 	return ret;
 }
-- 
2.10.2

