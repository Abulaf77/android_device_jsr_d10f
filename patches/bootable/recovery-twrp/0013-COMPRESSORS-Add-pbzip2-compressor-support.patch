From 92383ac1e2d6c762c9d6f7fde3b9b03e28143549 Mon Sep 17 00:00:00 2001
From: S-trace <S-trace@list.ru>
Date: Mon, 13 Mar 2017 20:50:22 +0300
Subject: [PATCH 13/20] [COMPRESSORS] Add pbzip2 compressor support

---
 Android.mk                     |  3 ++-
 gui/theme/common/landscape.xml |  9 +++++++
 gui/theme/common/portrait.xml  |  9 +++++++
 gui/theme/common/watch.xml     |  9 +++++++
 pbzip2/Android.mk              | 58 ++++++++++++++++++++++++++++++++++++++++++
 prebuilt/Android.mk            |  1 +
 twrp-functions.cpp             |  9 +++++++
 twrpTar.cpp                    | 27 ++++++++++++++++++++
 8 files changed, 124 insertions(+), 1 deletion(-)
 create mode 100644 pbzip2/Android.mk

diff --git a/Android.mk b/Android.mk
index 1600d05..9cf0c17 100644
--- a/Android.mk
+++ b/Android.mk
@@ -464,7 +464,7 @@ ifeq ($(TWRP_INCLUDE_LOGCAT), true)
     endif
 endif
 ifneq ($(TW_NO_ADVANCED_COMPRESSION), true)
-    LOCAL_ADDITIONAL_DEPENDENCIES += uunpack zstd
+    LOCAL_ADDITIONAL_DEPENDENCIES += uunpack zstd pbzip2
 endif
 # Allow devices to specify device-specific recovery dependencies
 ifneq ($(TARGET_RECOVERY_DEVICE_MODULES),)
@@ -730,6 +730,7 @@ endif
 ifneq ($(TW_NO_ADVANCED_COMPRESSION), true)
     include $(commands_recovery_local_path)/uunpack/Android.mk
     include $(commands_recovery_local_path)/zstd/Android.mk
+    include $(commands_recovery_local_path)/pbzip2/Android.mk
 endif
 
 # FB2PNG
diff --git a/gui/theme/common/landscape.xml b/gui/theme/common/landscape.xml
index 11a75d4..4e5cd5a 100644
--- a/gui/theme/common/landscape.xml
+++ b/gui/theme/common/landscape.xml
@@ -1763,6 +1763,15 @@
 				<listitem name="pigz -7">pigz -7</listitem>
 				<listitem name="pigz -8">pigz -8</listitem>
 				<listitem name="pigz -9">pigz -9</listitem>
+				<listitem name="pbzip2 -1">pbzip2 -1</listitem>
+				<listitem name="pbzip2 -2">pbzip2 -2</listitem>
+				<listitem name="pbzip2 -3">pbzip2 -3</listitem>
+				<listitem name="pbzip2 -4">pbzip2 -4</listitem>
+				<listitem name="pbzip2 -5">pbzip2 -5</listitem>
+				<listitem name="pbzip2 -6">pbzip2 -6</listitem>
+				<listitem name="pbzip2 -7">pbzip2 -7</listitem>
+				<listitem name="pbzip2 -8">pbzip2 -8</listitem>
+				<listitem name="pbzip2 -9">pbzip2 -9</listitem>
 				<listitem name="zstd -1">zstd -1</listitem>
 				<listitem name="zstd -2">zstd -2</listitem>
 				<listitem name="zstd -3">zstd -3</listitem>
diff --git a/gui/theme/common/portrait.xml b/gui/theme/common/portrait.xml
index 53f8e2b..a54816b 100644
--- a/gui/theme/common/portrait.xml
+++ b/gui/theme/common/portrait.xml
@@ -1808,6 +1808,15 @@
 				<listitem name="pigz -7">pigz -7</listitem>
 				<listitem name="pigz -8">pigz -8</listitem>
 				<listitem name="pigz -9">pigz -9</listitem>
+				<listitem name="pbzip2 -1">pbzip2 -1</listitem>
+				<listitem name="pbzip2 -2">pbzip2 -2</listitem>
+				<listitem name="pbzip2 -3">pbzip2 -3</listitem>
+				<listitem name="pbzip2 -4">pbzip2 -4</listitem>
+				<listitem name="pbzip2 -5">pbzip2 -5</listitem>
+				<listitem name="pbzip2 -6">pbzip2 -6</listitem>
+				<listitem name="pbzip2 -7">pbzip2 -7</listitem>
+				<listitem name="pbzip2 -8">pbzip2 -8</listitem>
+				<listitem name="pbzip2 -9">pbzip2 -9</listitem>
 				<listitem name="zstd -1">zstd -1</listitem>
 				<listitem name="zstd -2">zstd -2</listitem>
 				<listitem name="zstd -3">zstd -3</listitem>
diff --git a/gui/theme/common/watch.xml b/gui/theme/common/watch.xml
index 2e4c691..7d011d9 100644
--- a/gui/theme/common/watch.xml
+++ b/gui/theme/common/watch.xml
@@ -2140,6 +2140,15 @@
 				<listitem name="pigz -7">pigz -7</listitem>
 				<listitem name="pigz -8">pigz -8</listitem>
 				<listitem name="pigz -9">pigz -9</listitem>
+				<listitem name="pbzip2 -1">pbzip2 -1</listitem>
+				<listitem name="pbzip2 -2">pbzip2 -2</listitem>
+				<listitem name="pbzip2 -3">pbzip2 -3</listitem>
+				<listitem name="pbzip2 -4">pbzip2 -4</listitem>
+				<listitem name="pbzip2 -5">pbzip2 -5</listitem>
+				<listitem name="pbzip2 -6">pbzip2 -6</listitem>
+				<listitem name="pbzip2 -7">pbzip2 -7</listitem>
+				<listitem name="pbzip2 -8">pbzip2 -8</listitem>
+				<listitem name="pbzip2 -9">pbzip2 -9</listitem>
 				<listitem name="zstd -1">zstd -1</listitem>
 				<listitem name="zstd -2">zstd -2</listitem>
 				<listitem name="zstd -3">zstd -3</listitem>
diff --git a/pbzip2/Android.mk b/pbzip2/Android.mk
new file mode 100644
index 0000000..01f963b
--- /dev/null
+++ b/pbzip2/Android.mk
@@ -0,0 +1,58 @@
+# Copyright (C) 2008 The Android Open Source Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+LOCAL_PATH := $(call my-dir)
+include $(CLEAR_VARS)
+
+# measurements show that the ARM version of ZLib is about x1.17 faster
+# than the thumb one...
+LOCAL_MODULE := pbzip2
+LOCAL_MODULE_TAGS := eng optional
+LOCAL_MODULE_CLASS := RECOVERY_EXECUTABLES
+LOCAL_MODULE_PATH := $(TARGET_RECOVERY_ROOT_OUT)/sbin
+LOCAL_ARM_MODE := arm
+
+LOCAL_C_INCLUDES += \
+			external/bzip2
+
+LOCAL_SRC_FILES := \
+	pbzip2.cpp \
+	BZ2StreamScanner.cpp \
+	ErrorContext.cpp
+
+LOCAL_STATIC_LIBRARIES := libbz
+ifeq ($(shell test $(PLATFORM_SDK_VERSION) -lt 23; echo $$?),0)
+    LOCAL_LDLIBS += -lpthread
+    LOCAL_SHARED_LIBRARIES := libstlport
+    LOCAL_C_INCLUDES += \
+        external/stlport/stlport \
+        external/stlport/stlport/stl \
+        external/stlport/stlport/using/h \
+        bionic
+else
+    LOCAL_SHARED_LIBRARIES += libc++
+endif
+# LOCAL_SHARED_LIBRARIES := libpthread
+
+LOCAL_CPPFLAGS += -O2 \
+	-pthread \
+	-D_LARGEFILE64_SOURCE \
+	-D_FILE_OFFSET_BITS=64 \
+	-DUSE_STACKSIZE_CUSTOMIZATION \
+	-D_POSIX_PTHREAD_SEMANTICS \
+	-DPBZIP_NO_LOADAVG \
+	-Wno-reserved-user-defined-literal
+
+
+include $(BUILD_EXECUTABLE)
diff --git a/prebuilt/Android.mk b/prebuilt/Android.mk
index e8f0f52..f7af93e 100644
--- a/prebuilt/Android.mk
+++ b/prebuilt/Android.mk
@@ -31,6 +31,7 @@ else
 	endif
 endif
 ifneq ($(TW_NO_ADVANCED_COMPRESSION), true)
+	RELINK_SOURCE_FILES += $(TARGET_RECOVERY_ROOT_OUT)/sbin/pbzip2
 	RELINK_SOURCE_FILES += $(TARGET_RECOVERY_ROOT_OUT)/sbin/zstd
 	RELINK_SOURCE_FILES += $(TARGET_RECOVERY_ROOT_OUT)/sbin/uunpack
 endif
diff --git a/twrp-functions.cpp b/twrp-functions.cpp
index ae18cbf..a3a0eca 100644
--- a/twrp-functions.cpp
+++ b/twrp-functions.cpp
@@ -203,6 +203,10 @@ Archive_Type TWFunc::Get_File_Type(string fn) {
 		LOGINFO("File '%s' is compressed by gzip/pigz.\n", fn.c_str());
 		return COMPRESSED; // Compressed by gzip/pigz
 	}
+	else if (firstbyte == 0x42 && secondbyte == 0x5a && thirdbyte == 0x68) {
+		LOGINFO("File '%s' is compressed by bzip2.\n", fn.c_str());
+		return COMPRESSED; // Compressed by bzip2
+	}
 	else if (secondbyte == 0xb5 && thirdbyte == 0x2f && fourthbyte == 0xfd) {
 		LOGINFO("File '%s' is compressed by zstd.\n", fn.c_str());
 		return COMPRESSED; // Compressed by zstd
@@ -301,6 +305,11 @@ int TWFunc::Try_Decrypting_File(string fn, string password) {
 		free(buffer_out);
 		return 3; // Compressed by gzip/pigz+encrypted
 	}
+	else if (firstbyte == 0x42 && secondbyte == 0x5a && thirdbyte == 0x68) {
+		LOGINFO("Successfully decrypted '%s' and file is compressed by bzip2.\n", fn.c_str());
+		free(buffer_out);
+		return 3; // Compressed by bzip2+encrypted
+	}
 	else if (secondbyte == 0xb5 && thirdbyte == 0x2f && fourthbyte == 0xfd) {
 		LOGINFO("Successfully decrypted '%s' and file is compressed by zstd.\n", fn.c_str());
 		free(buffer_out);
diff --git a/twrpTar.cpp b/twrpTar.cpp
index b731d56..dddcb03 100644
--- a/twrpTar.cpp
+++ b/twrpTar.cpp
@@ -931,6 +931,33 @@ int twrpTar::execlpCompressor() {
 	if (compression_mode == "pigz -9")
 		ret=execlp("pigz", "pigz", "-9", "-", NULL);
 
+	if (compression_mode == "pbzip2 -1")
+		ret=execlp("pbzip2", "pbzip2", "-1", NULL);
+
+	if (compression_mode == "pbzip2 -2")
+		ret=execlp("pbzip2", "pbzip2", "-2", NULL);
+
+	if (compression_mode == "pbzip2 -3")
+		ret=execlp("pbzip2", "pbzip2", "-3", NULL);
+
+	if (compression_mode == "pbzip2 -4")
+		ret=execlp("pbzip2", "pbzip2", "-4", NULL);
+
+	if (compression_mode == "pbzip2 -5")
+		ret=execlp("pbzip2", "pbzip2", "-5", NULL);
+
+	if (compression_mode == "pbzip2 -6")
+		ret=execlp("pbzip2", "pbzip2", "-6", NULL);
+
+	if (compression_mode == "pbzip2 -7")
+		ret=execlp("pbzip2", "pbzip2", "-7", NULL);
+
+	if (compression_mode == "pbzip2 -8")
+		ret=execlp("pbzip2", "pbzip2", "-8", NULL);
+
+	if (compression_mode == "pbzip2 -9")
+		ret=execlp("pbzip2", "pbzip2", "-9", NULL);
+
 	if (compression_mode == "zstd -1")
 		ret=execlp("zstd", "zstd", "-1", "-", NULL);
 
-- 
2.10.2

